name: Build Flutter APK

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'
          channel: 'stable'

      - name: Get dependencies
        run: flutter pub get

      - name: Generate icons (mipmap)
        run: |
          python3 - << 'EOF'
          from PIL import Image, ImageDraw
          import os

          def make_icon(size):
              img = Image.new("RGBA", (size, size), (0,0,0,0))
              draw = ImageDraw.Draw(img)
              draw.ellipse([0,0,size-1,size-1], fill=(7,7,13,255))
              m = size//10
              draw.ellipse([m,m,size-m-1,size-m-1], outline=(0,229,255,255), width=max(2,size//20))
              cx,cy,r = size//2,size//2,size//4
              draw.polygon([(cx,cy-r),(cx-r,cy+r//2),(cx+r,cy+r//2)], fill=(0,229,255,255))
              return img

          mipmaps = {"mipmap-mdpi":48,"mipmap-hdpi":72,"mipmap-xhdpi":96,
                     "mipmap-xxhdpi":144,"mipmap-xxxhdpi":192}
          base = "android/app/src/main/res"
          for folder, size in mipmaps.items():
              path = os.path.join(base, folder)
              os.makedirs(path, exist_ok=True)
              icon = make_icon(size)
              icon.save(os.path.join(path, "ic_launcher.png"))
              icon.save(os.path.join(path, "ic_launcher_round.png"))
              print(f"✅ {folder} ({size}px)")
          EOF
          pip install pillow -q && python3 /tmp/gen_icons.py 2>/dev/null || true

      - name: Create accessibility config
        run: |
          mkdir -p android/app/src/main/res/xml
          cat > android/app/src/main/res/xml/accessibility_service_config.xml << 'XML'
          <?xml version="1.0" encoding="utf-8"?>
          <accessibility-service
              xmlns:android="http://schemas.android.com/apk/res/android"
              android:description="@string/app_name"
              android:accessibilityEventTypes="typeAllMask"
              android:accessibilityFlags="flagDefault"
              android:accessibilityFeedbackType="feedbackGeneric"
              android:notificationTimeout="100"
              android:canPerformGestures="true"
              android:canRetrieveWindowContent="true"/>
          XML

      - name: Build debug APK
        run: flutter build apk --debug

      - name: Build release APK
        run: flutter build apk --release

      - name: List outputs
        if: always()
        run: find build/app/outputs -name "*.apk" 2>/dev/null || echo "No APKs"

      - name: Upload debug APK
        uses: actions/upload-artifact@v4
        with:
          name: flutter-iqbot-debug
          path: build/app/outputs/flutter-apk/app-debug.apk
          retention-days: 30

      - name: Upload release APK
        uses: actions/upload-artifact@v4
        with:
          name: flutter-iqbot-release
          path: build/app/outputs/flutter-apk/app-release.apk
          retention-days: 30

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          name: "IQ Option Bot Flutter ${{ github.ref_name }}"
          body: |
            ## IQ Option Bot — Flutter Edition ${{ github.ref_name }}

            ### Install:
            1. Download `app-debug.apk`
            2. Phone → Settings → Security → Allow unknown sources
            3. Install → Grant Overlay + Accessibility permissions
            4. Screenshot the Higher button → Browse → select it → START

            **Android 8.0+ required**
          files: |
            build/app/outputs/flutter-apk/app-debug.apk
            build/app/outputs/flutter-apk/app-release.apk
